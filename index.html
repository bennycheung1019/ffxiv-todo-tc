<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFXIV 例行清單（每日/每週）</title>
  <style>
    :root {
      --bg: #0b1220;
      --text: #e8eefc;
      --muted: #9fb1d8;
      --line: rgba(255, 255, 255, .10);
      --accent: #6ee7ff;
      --accent2: #a78bfa;
      --good: #34d399;
      --bad: #fb7185;
      --shadow: 0 12px 28px rgba(0, 0, 0, .35);
      --radius: 16px;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(110, 231, 255, .18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(167, 139, 250, .18), transparent 55%),
        var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px
    }

    .sub {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35
    }

    .pillrow {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
    }

    .btn {
      appearance: none;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .05);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease;
      user-select: none;
      white-space: nowrap;
    }

    .btn:hover {
      background: rgba(255, 255, 255, .08)
    }

    .btn:active {
      transform: translateY(1px)
    }

    .btn.primary {
      border-color: rgba(110, 231, 255, .35);
      background: rgba(110, 231, 255, .12)
    }

    .btn.primary2 {
      border-color: rgba(167, 139, 250, .35);
      background: rgba(167, 139, 250, .12)
    }

    .btn.danger {
      border-color: rgba(251, 113, 133, .35);
      background: rgba(251, 113, 133, .10)
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .hd {
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(0, 0, 0, .12);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .label {
      font-weight: 700;
      font-size: 13px
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .body {
      padding: 12px 14px 14px 14px
    }

    .progress {
      height: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }

    .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2))
    }

    .kpi {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap
    }

    .kpi .k {
      font-size: 12px;
      color: var(--muted)
    }

    .kpi .v {
      font-size: 12px
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px
    }

    .item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0, 0, 0, .10);
    }

    .item:hover {
      background: rgba(0, 0, 0, .14)
    }

    .ck {
      margin-top: 2px;
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .name {
      font-size: 13px;
      font-weight: 650;
      line-height: 1.25;
      word-break: break-word
    }

    /* Modal */
    .modalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 100;
    }

    .modal {
      width: min(760px, 96vw);
      max-height: 86vh;
      overflow: auto;
      background: linear-gradient(180deg, rgba(15, 27, 49, .98), rgba(15, 27, 49, .92));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
    }

    .modalHd {
      position: sticky;
      top: 0;
      background: rgba(0, 0, 0, .18);
      border-bottom: 1px solid var(--line);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .modalTitle {
      font-weight: 800;
      font-size: 13px
    }

    .modalBody {
      padding: 12px 14px 14px 14px
    }

    .taskAdd {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .taskInput {
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .05);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      outline: none;
    }

    .taskInput::placeholder {
      color: var(--muted);
    }

    .taskInput:focus {
      border-color: rgba(110, 231, 255, .35);
    }

    .tmplList {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .tmplItem {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(255, 255, 255, .03);
    }

    .tmplName {
      flex: 1;
      min-width: 0;
      font-size: 13px;
      font-weight: 650;
      line-height: 1.25;
      word-break: break-word
    }

    .tmplActions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .tmplToggleBtn {
      min-width: 56px;
    }

    .btn.deleteStrong {
      border-color: #dc2626;
      background: #dc2626;
      color: #fff;
    }

    .btn.deleteStrong:hover {
      background: #b91c1c;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(15, 27, 49, .96);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 12px;
      display: none;
      z-index: 120;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>FFXIV 例行清單（每日 / 每週）</h1>
        <div class="sub">重置時間（HKT）：每日 23:00｜每週二 16:00</div>
        <div class="pillrow">
          <div class="pill">登入狀態：<b id="authState">未登入</b></div>
          <div class="pill">雲端同步：<b id="syncState">未啟用</b></div>
        </div>
      </div>
      <div class="pillrow">
        <button class="btn primary" id="btnLogin">Google 登入</button>
        <button class="btn danger" id="btnLogout" style="display:none;">登出</button>
      </div>
    </header>

    <div class="grid">
      <!-- DAILY (LEFT) -->
      <section class="card">
        <div class="hd">
          <div>
            <div class="label">每日清單</div>
            <div class="meta">
              <span class="mono" id="dyPeriodKey"></span>
              <span>｜距離下次重置：<b id="dyCountdown">—</b></span>
            </div>
          </div>
          <div class="pillrow">
            <button class="btn primary" id="dyManage">加入/移除項目</button>
            <button class="btn" id="dyUncheck">取消本期全部勾選</button>
          </div>
        </div>
        <div class="body">
          <div class="progress">
            <div class="bar" id="dyBar"></div>
          </div>
          <div class="kpi">
            <div><span class="k">完成</span> <span class="v"><b id="dyDone">0</b>/<b id="dyTotal">0</b></span></div>
            <div><span class="k">完成率</span> <span class="v"><b id="dyPct">0%</b></span></div>
          </div>
          <div class="list" id="dyList"></div>
        </div>
      </section>

      <!-- WEEKLY (RIGHT) -->
      <section class="card">
        <div class="hd">
          <div>
            <div class="label">每週清單</div>
            <div class="meta">
              <span class="mono" id="wkPeriodKey"></span>
              <span>｜距離下次重置：<b id="wkCountdown">—</b></span>
            </div>
          </div>
          <div class="pillrow">
            <button class="btn primary2" id="wkManage">加入/移除項目</button>
            <button class="btn" id="wkUncheck">取消本期全部勾選</button>
          </div>
        </div>
        <div class="body">
          <div class="progress">
            <div class="bar" id="wkBar"></div>
          </div>
          <div class="kpi">
            <div><span class="k">完成</span> <span class="v"><b id="wkDone">0</b>/<b id="wkTotal">0</b></span></div>
            <div><span class="k">完成率</span> <span class="v"><b id="wkPct">0%</b></span></div>
          </div>
          <div class="list" id="wkList"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Daily Modal -->
  <div class="modalBackdrop" id="dyModal">
    <div class="modal" role="dialog" aria-modal="true" aria-label="每日項目管理">
      <div class="modalHd">
        <div class="modalTitle">每日：加入/移除項目</div>
        <div class="pillrow">
          <button class="btn" id="dyEnableAll">全部加入</button>
          <button class="btn" id="dyDisableAll">全部移除</button>
          <button class="btn" id="dyClose">關閉</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="taskAdd">
          <input class="taskInput" id="dyCustomName" maxlength="60" placeholder="新增自訂項目名稱" />
          <button class="btn primary" id="dyAddTask">新增</button>
        </div>
        <div class="tmplList" id="dyTemplates"></div>
      </div>
    </div>
  </div>

  <!-- Weekly Modal -->
  <div class="modalBackdrop" id="wkModal">
    <div class="modal" role="dialog" aria-modal="true" aria-label="每週項目管理">
      <div class="modalHd">
        <div class="modalTitle">每週：加入/移除項目</div>
        <div class="pillrow">
          <button class="btn" id="wkEnableAll">全部加入</button>
          <button class="btn" id="wkDisableAll">全部移除</button>
          <button class="btn" id="wkClose">關閉</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="taskAdd">
          <input class="taskInput" id="wkCustomName" maxlength="60" placeholder="新增自訂項目名稱" />
          <button class="btn primary2" id="wkAddTask">新增</button>
        </div>
        <div class="tmplList" id="wkTemplates"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ✅ Firebase + Firestore + Google Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // ==========================================================
    // ✅ 你的 Firebase config（已幫你填好）
    // ==========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCQwlEqq7CtfC02MCiis_45rRltxInJJWo",
      authDomain: "ffxiv-todo.firebaseapp.com",
      projectId: "ffxiv-todo",
      storageBucket: "ffxiv-todo.firebasestorage.app",
      messagingSenderId: "641826809761",
      appId: "1:641826809761:web:a874abbd2bc6074d4acde0",
      measurementId: "G-H16TGZ89FQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ==========================================================
    // ✅ 名稱（你之後可自行校正官方詞）
    // ==========================================================
    const UI_TEXT = {
      // Weekly
      wk_hunt: "每週狩獵標記",
      wk_squadron_priority: "分隊：優先任務",
      wk_challenge_log: "挑戰筆記",
      wk_custom_delivery: "老僱主",
      wk_wondrous_tails: "天書奇談",
      wk_normal_lockout: "普通團隊副本：每週獎勵限制",
      wk_savage_lockout: "零式團隊副本：每週獎勵限制",
      wk_alliance_lockout: "24人團隊副本：每週獎勵限制",
      wk_faux_hollows: "幻巧",
      wk_tomestone_cap: "（週限）神典石：取得上限",
      wk_doman: "多瑪飛地：捐獻",
      wk_masked: "假面狂歡（每週目標）",
      wk_blue_log: "青魔：青魔日誌",
      wk_gold_tourney: "金碟遊樂場：錦標賽",
      wk_fashion: "時尚品鑑",
      wk_jumbo: "仙人仙彩",
      wk_island: "無人島開拓：每週",

      // Daily
      dy_hunt: "每日狩獵標記",
      dy_squadron: "冒險者分隊",
      dy_gc_turnins: "大國防聯軍：籌備任務",
      dy_fc_voyage: "公會：遠征（飛空艇/潛水艇）",
      dy_retainer: "雇員探險",
      dy_housing: "住宅：園藝/種植",
      dy_tribal: "友好部族任務",
      dy_treasure_map: "取得藏寶圖",
      dy_leve: "理符任務",
      dy_roulettes: "每日隨機任務",
      dy_mini: "仙人微彩",
      dy_island: "無人島開拓：每日"
    };

    const WEEKLY_ITEMS = [
      { id: "wk_hunt", name: () => UI_TEXT.wk_hunt },
      { id: "wk_squadron_priority", name: () => UI_TEXT.wk_squadron_priority },
      { id: "wk_challenge_log", name: () => UI_TEXT.wk_challenge_log },
      { id: "wk_custom_delivery", name: () => UI_TEXT.wk_custom_delivery },
      { id: "wk_wondrous_tails", name: () => UI_TEXT.wk_wondrous_tails },
      { id: "wk_normal_lockout", name: () => UI_TEXT.wk_normal_lockout },
      { id: "wk_savage_lockout", name: () => UI_TEXT.wk_savage_lockout },
      { id: "wk_alliance_lockout", name: () => UI_TEXT.wk_alliance_lockout },
      { id: "wk_faux_hollows", name: () => UI_TEXT.wk_faux_hollows },
      { id: "wk_tomestone_cap", name: () => UI_TEXT.wk_tomestone_cap },
      { id: "wk_doman", name: () => UI_TEXT.wk_doman },
      { id: "wk_masked", name: () => UI_TEXT.wk_masked },
      { id: "wk_blue_log", name: () => UI_TEXT.wk_blue_log },
      { id: "wk_gold_tourney", name: () => UI_TEXT.wk_gold_tourney },
      { id: "wk_fashion", name: () => UI_TEXT.wk_fashion },
      { id: "wk_jumbo", name: () => UI_TEXT.wk_jumbo },
      { id: "wk_island", name: () => UI_TEXT.wk_island }
    ];

    const DAILY_ITEMS = [
      { id: "dy_hunt", name: () => UI_TEXT.dy_hunt },
      { id: "dy_squadron", name: () => UI_TEXT.dy_squadron },
      { id: "dy_gc_turnins", name: () => UI_TEXT.dy_gc_turnins },
      { id: "dy_fc_voyage", name: () => UI_TEXT.dy_fc_voyage },
      { id: "dy_retainer", name: () => UI_TEXT.dy_retainer },
      { id: "dy_housing", name: () => UI_TEXT.dy_housing },
      { id: "dy_tribal", name: () => UI_TEXT.dy_tribal },
      { id: "dy_treasure_map", name: () => UI_TEXT.dy_treasure_map },
      { id: "dy_leve", name: () => UI_TEXT.dy_leve },
      { id: "dy_roulettes", name: () => UI_TEXT.dy_roulettes },
      { id: "dy_mini", name: () => UI_TEXT.dy_mini },
      { id: "dy_island", name: () => UI_TEXT.dy_island }
    ];

    // ==========================================================
    // ✅ HKT 時間（UTC+8）
    // ==========================================================
    const TZ_OFFSET_MIN = 8 * 60;
    const DAILY_RESET_HOUR = 23, DAILY_RESET_MIN = 0;
    const WEEKLY_RESET_DOW = 2, WEEKLY_RESET_HOUR = 16, WEEKLY_RESET_MIN = 0;

    function nowUtcMs() { return Date.now(); }
    function toTzDate(msUtc) { return new Date(msUtc + TZ_OFFSET_MIN * 60 * 1000); }
    function fromTzPartsToUtcMs(y, m, d, hh, mm) {
      const ms = Date.UTC(y, m, d, hh, mm, 0, 0);
      return ms - TZ_OFFSET_MIN * 60 * 1000;
    }
    function fmt2(n) { return String(n).padStart(2, '0'); }

    function periodStartDailyUtcMs(msUtc) {
      const t = toTzDate(msUtc);
      const y = t.getUTCFullYear(), m = t.getUTCMonth(), d = t.getUTCDate();
      const todayResetUtc = fromTzPartsToUtcMs(y, m, d, DAILY_RESET_HOUR, DAILY_RESET_MIN);
      if (msUtc >= todayResetUtc) return todayResetUtc;
      const yest = new Date(Date.UTC(y, m, d) - 24 * 3600 * 1000);
      return fromTzPartsToUtcMs(yest.getUTCFullYear(), yest.getUTCMonth(), yest.getUTCDate(), DAILY_RESET_HOUR, DAILY_RESET_MIN);
    }
    function nextResetDailyUtcMs(msUtc) { return periodStartDailyUtcMs(msUtc) + 24 * 3600 * 1000; }

    function periodStartWeeklyUtcMs(msUtc) {
      const t = toTzDate(msUtc);
      const y = t.getUTCFullYear(), m = t.getUTCMonth(), d = t.getUTCDate();
      const dow = t.getUTCDay();
      const daysSinceTue = (dow - WEEKLY_RESET_DOW + 7) % 7;
      const thisTue = new Date(Date.UTC(y, m, d) - daysSinceTue * 24 * 3600 * 1000);
      const thisTueResetUtc = fromTzPartsToUtcMs(thisTue.getUTCFullYear(), thisTue.getUTCMonth(), thisTue.getUTCDate(), WEEKLY_RESET_HOUR, WEEKLY_RESET_MIN);
      if (msUtc >= thisTueResetUtc) return thisTueResetUtc;
      return thisTueResetUtc - 7 * 24 * 3600 * 1000;
    }
    function nextResetWeeklyUtcMs(msUtc) { return periodStartWeeklyUtcMs(msUtc) + 7 * 24 * 3600 * 1000; }

    function periodKey(mode, msUtc) {
      const start = (mode === 'daily') ? periodStartDailyUtcMs(msUtc) : periodStartWeeklyUtcMs(msUtc);
      const t = toTzDate(start);
      const y = t.getUTCFullYear(), m = t.getUTCMonth() + 1, d = t.getUTCDate(), hh = t.getUTCHours(), mm = t.getUTCMinutes();
      return `${mode}:${y}-${fmt2(m)}-${fmt2(d)} ${fmt2(hh)}:${fmt2(mm)} (HKT)`;
    }
    function formatCountdown(ms) {
      ms = Math.max(0, ms);
      const s = Math.floor(ms / 1000);
      const dd = Math.floor(s / 86400);
      const hh = Math.floor((s % 86400) / 3600);
      const mm = Math.floor((s % 3600) / 60);
      if (dd > 0) return `${dd}天 ${hh}小時 ${mm}分`;
      if (hh > 0) return `${hh}小時 ${mm}分`;
      return `${mm}分`;
    }

    // ==========================================================
    // ✅ 本機資料結構
    // ==========================================================
    const LS_KEY = 'ffxiv_todo_local_cache_v2_firebase';
    const DEFAULT_DATA = {
      enabled: {
        weekly: Object.fromEntries(WEEKLY_ITEMS.map(x => [x.id, true])),
        daily: Object.fromEntries(DAILY_ITEMS.map(x => [x.id, true]))
      },
      custom: {
        weekly: [],
        daily: []
      },
      checked: {}, // periodKey -> { itemId: true }
      meta: { updatedAt: 0 } // 本機最後更新時間（ms）
    };

    function structuredCloneSafe(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function mergeWithDefaults(input) {
      const merged = structuredCloneSafe(DEFAULT_DATA);
      if (input?.enabled) merged.enabled = Object.assign(merged.enabled, input.enabled);
      if (input?.custom) merged.custom = Object.assign(merged.custom, input.custom);
      if (input?.checked) merged.checked = input.checked;
      if (input?.meta) merged.meta = Object.assign(merged.meta, input.meta);

      merged.enabled.weekly ||= {};
      merged.enabled.daily ||= {};
      merged.custom.weekly = Array.isArray(merged.custom.weekly) ? merged.custom.weekly : [];
      merged.custom.daily = Array.isArray(merged.custom.daily) ? merged.custom.daily : [];
      for (const it of WEEKLY_ITEMS) if (!(it.id in merged.enabled.weekly)) merged.enabled.weekly[it.id] = true;
      for (const it of DAILY_ITEMS) if (!(it.id in merged.enabled.daily)) merged.enabled.daily[it.id] = true;
      merged.custom.weekly = merged.custom.weekly.filter(it => typeof it?.id === 'string' && typeof it?.name === 'string' && it.name.trim());
      merged.custom.daily = merged.custom.daily.filter(it => typeof it?.id === 'string' && typeof it?.name === 'string' && it.name.trim());
      for (const it of merged.custom.weekly) if (!(it.id in merged.enabled.weekly)) merged.enabled.weekly[it.id] = true;
      for (const it of merged.custom.daily) if (!(it.id in merged.enabled.daily)) merged.enabled.daily[it.id] = true;

      merged.meta.updatedAt ||= 0;
      return merged;
    }

    function loadLocal() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return structuredCloneSafe(DEFAULT_DATA);
        return mergeWithDefaults(JSON.parse(raw));
      } catch {
        return structuredCloneSafe(DEFAULT_DATA);
      }
    }

    function touchLocalUpdated() {
      DATA.meta.updatedAt = Date.now();
    }

    function saveLocal() {
      localStorage.setItem(LS_KEY, JSON.stringify(DATA));
    }

    let DATA = loadLocal();

    // ==========================================================
    // ✅ Firebase Auth + Firestore 同步
    // Firestore 文件：users/{uid}
    // 結構：{ data: <DATA>, updatedAt: <ms> }
    // ==========================================================
    let currentUser = null;

    const authStateEl = document.getElementById('authState');
    const syncStateEl = document.getElementById('syncState');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.style.display = 'none', 1500);
    }

    function setAuthUI() {
      if (currentUser) {
        authStateEl.textContent = '已登入';
        btnLogin.style.display = 'none';
        btnLogout.style.display = '';
      } else {
        authStateEl.textContent = '未登入';
        btnLogin.style.display = '';
        btnLogout.style.display = 'none';
      }
    }

    function setSyncState(text) { syncStateEl.textContent = text; }

    async function loginGoogle() {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.warn(e);
        toast('登入失敗（請檢查 Firebase Auth / 授權網域）');
      }
    }

    async function logout() {
      try {
        await signOut(auth);
      } catch (e) {
        console.warn(e);
      }
      currentUser = null;
      setAuthUI();
      setSyncState('未啟用');
      toast('已登出');
    }

    async function cloudLoadThenResolve() {
      if (!currentUser) return;
      setSyncState('同步中…');

      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        // 雲端無資料：把本機推上去
        await cloudSaveNow(true);
        setSyncState('已啟用');
        return;
      }

      const cloud = snap.data() || {};
      const cloudData = mergeWithDefaults(cloud.data || {});
      const cloudUpdatedAt = Number(cloud.updatedAt || 0);
      const localUpdatedAt = Number(DATA.meta.updatedAt || 0);

      // 決策：時間較新者勝（避免「本機舊資料蓋掉雲端新資料」）
      if (cloudUpdatedAt > localUpdatedAt) {
        DATA = cloudData;
        saveLocal();
        renderAll();
      } else {
        // 本機較新：推上雲端
        await cloudSaveNow(true);
      }
      setSyncState('已啟用');
    }

    let _saveTimer = null;
    function cloudSaveDebounced() {
      if (!currentUser) return;
      clearTimeout(_saveTimer);
      _saveTimer = setTimeout(() => cloudSaveNow(false), 350);
    }

    async function cloudSaveNow(showToast) {
      if (!currentUser) return;
      try {
        setSyncState('同步中…');
        const ref = doc(db, "users", currentUser.uid);
        const payload = {
          data: DATA,
          updatedAt: Date.now()
        };
        await setDoc(ref, payload, { merge: true });
        setSyncState('已啟用');
        if (showToast) toast('已同步雲端');
      } catch (e) {
        console.warn(e);
        setSyncState('同步失敗');
      }
    }

    async function flushCloudSave() {
      if (!currentUser) return;
      clearTimeout(_saveTimer);
      _saveTimer = null;
      await cloudSaveNow(false);
    }

    // ==========================================================
    // ✅ UI refs
    // ==========================================================
    const dyPeriodKeyEl = document.getElementById('dyPeriodKey');
    const dyCountdownEl = document.getElementById('dyCountdown');
    const dyListEl = document.getElementById('dyList');
    const dyBarEl = document.getElementById('dyBar');
    const dyDoneEl = document.getElementById('dyDone');
    const dyTotalEl = document.getElementById('dyTotal');
    const dyPctEl = document.getElementById('dyPct');

    const wkPeriodKeyEl = document.getElementById('wkPeriodKey');
    const wkCountdownEl = document.getElementById('wkCountdown');
    const wkListEl = document.getElementById('wkList');
    const wkBarEl = document.getElementById('wkBar');
    const wkDoneEl = document.getElementById('wkDone');
    const wkTotalEl = document.getElementById('wkTotal');
    const wkPctEl = document.getElementById('wkPct');

    const dyModal = document.getElementById('dyModal');
    const wkModal = document.getElementById('wkModal');
    const dyTemplatesEl = document.getElementById('dyTemplates');
    const wkTemplatesEl = document.getElementById('wkTemplates');
    const dyCustomNameEl = document.getElementById('dyCustomName');
    const wkCustomNameEl = document.getElementById('wkCustomName');

    function getItems(mode) {
      const baseItems = mode === 'daily' ? DAILY_ITEMS : WEEKLY_ITEMS;
      const customItems = (DATA.custom[mode] || []).map(it => ({
        id: it.id,
        name: () => it.name,
        isCustom: true
      }));
      return [...baseItems, ...customItems];
    }

    function makeCustomTaskId(mode) {
      const rand = Math.random().toString(36).slice(2, 8);
      return `custom_${mode}_${Date.now().toString(36)}_${rand}`;
    }

    function addCustomTask(mode, inputEl) {
      const raw = (inputEl.value || '').trim();
      if (!raw) return;

      const name = raw.slice(0, 60);
      const id = makeCustomTaskId(mode);
      DATA.custom[mode].push({ id, name });
      DATA.enabled[mode][id] = true;

      inputEl.value = '';
      touchLocalUpdated();
      saveLocal();
      renderAll();
      renderModal(mode, mode === 'daily' ? dyTemplatesEl : wkTemplatesEl);
      cloudSaveDebounced();
    }

    function deleteCustomTask(mode, id) {
      DATA.custom[mode] = DATA.custom[mode].filter(it => it.id !== id);
      delete DATA.enabled[mode][id];
      for (const key of Object.keys(DATA.checked)) delete DATA.checked[key][id];

      touchLocalUpdated();
      saveLocal();
      renderAll();
      renderModal(mode, mode === 'daily' ? dyTemplatesEl : wkTemplatesEl);
      cloudSaveDebounced();
    }

    function getCheckedMap(mode) {
      const key = periodKey(mode, nowUtcMs());
      if (!DATA.checked[key]) DATA.checked[key] = {};
      return DATA.checked[key];
    }

    function renderTimers() {
      const now = nowUtcMs();
      dyPeriodKeyEl.textContent = periodKey('daily', now);
      wkPeriodKeyEl.textContent = periodKey('weekly', now);
      dyCountdownEl.textContent = formatCountdown(nextResetDailyUtcMs(now) - now);
      wkCountdownEl.textContent = formatCountdown(nextResetWeeklyUtcMs(now) - now);
    }

    function renderChecklist(mode, items, listEl, doneEl, totalEl, pctEl, barEl) {
      listEl.innerHTML = '';
      const enabledMap = DATA.enabled[mode];
      const checkedMap = getCheckedMap(mode);

      const enabledItems = items.filter(it => enabledMap[it.id]);

      for (const it of enabledItems) {
        const row = document.createElement('div');
        row.className = 'item';

        const ck = document.createElement('input');
        ck.type = 'checkbox';
        ck.className = 'ck';

        // ✅ 你問嘅呢行，就係喺「生成 checkbox」呢度
        ck.dataset.id = it.id;

        ck.checked = !!checkedMap[it.id];

        ck.addEventListener('change', () => {
          checkedMap[it.id] = ck.checked;

          touchLocalUpdated();
          saveLocal();

          renderChecklistKpi(enabledItems, checkedMap, doneEl, totalEl, pctEl, barEl);
          cloudSaveDebounced();
        });

        const txt = document.createElement('div');
        txt.className = 'name';
        txt.textContent = it.name();

        row.appendChild(ck);
        row.appendChild(txt);
        listEl.appendChild(row);
      }

      renderChecklistKpi(enabledItems, checkedMap, doneEl, totalEl, pctEl, barEl);
    }

    function renderChecklistKpi(enabledItems, checkedMap, doneEl, totalEl, pctEl, barEl) {
      let done = 0;
      for (const it of enabledItems) if (checkedMap[it.id]) done++;
      const total = enabledItems.length;
      totalEl.textContent = String(total);
      doneEl.textContent = String(done);
      const pct = total ? Math.round(done / total * 100) : 0;
      pctEl.textContent = pct + '%';
      barEl.style.width = pct + '%';
    }

    function renderModal(mode, containerEl) {
      containerEl.innerHTML = '';
      const enabledMap = DATA.enabled[mode];
      const items = getItems(mode);

      for (const it of items) {
        const row = document.createElement('div');
        row.className = 'tmplItem';

        const nm = document.createElement('div');
        nm.className = 'tmplName';
        nm.textContent = it.name();

        const btn = document.createElement('button');
        const isEnabled = !!enabledMap[it.id];
        btn.className = 'btn ' + (isEnabled ? 'danger' : (mode === 'weekly' ? 'primary2' : 'primary'));
        btn.classList.add('tmplToggleBtn');
        btn.textContent = isEnabled ? '移除' : '加入';

        btn.addEventListener('click', () => {
          enabledMap[it.id] = !isEnabled;

          touchLocalUpdated();
          saveLocal();

          renderAll();
          renderModal(mode, containerEl);
          cloudSaveDebounced();
        });

        row.appendChild(nm);
        const actions = document.createElement('div');
        actions.className = 'tmplActions';

        if (it.isCustom) {
          const delBtn = document.createElement('button');
          delBtn.className = 'btn deleteStrong';
          delBtn.textContent = '刪除';
          delBtn.addEventListener('click', () => deleteCustomTask(mode, it.id));
          actions.appendChild(delBtn);
        }
        actions.appendChild(btn);
        row.appendChild(actions);

        containerEl.appendChild(row);
      }
    }

    function openModal(which) {
      if (which === 'daily') {
        renderModal('daily', dyTemplatesEl);
        dyModal.style.display = 'flex';
      } else {
        renderModal('weekly', wkTemplatesEl);
        wkModal.style.display = 'flex';
      }
    }
    function closeModal(which) {
      if (which === 'daily') dyModal.style.display = 'none';
      else wkModal.style.display = 'none';
    }

    function enableAll(mode) {
      const items = getItems(mode);
      for (const it of items) DATA.enabled[mode][it.id] = true;

      touchLocalUpdated();
      saveLocal();
      renderAll();
      cloudSaveDebounced();
    }

    function disableAll(mode) {
      const items = getItems(mode);
      for (const it of items) DATA.enabled[mode][it.id] = false;

      touchLocalUpdated();
      saveLocal();
      renderAll();
      cloudSaveDebounced();
    }

    function uncheckAllThisPeriod(mode) {
      const checkedMap = getCheckedMap(mode);
      const items = getItems(mode);
      const enabledMap = DATA.enabled[mode];
      const enabledItems = items.filter(it => enabledMap[it.id]);

      for (const it of enabledItems) delete checkedMap[it.id];

      touchLocalUpdated();
      saveLocal();
      renderAll();
      cloudSaveDebounced();
    }

    function renderAll() {
      renderTimers();
      renderChecklist('daily', getItems('daily'), dyListEl, dyDoneEl, dyTotalEl, dyPctEl, dyBarEl);
      renderChecklist('weekly', getItems('weekly'), wkListEl, wkDoneEl, wkTotalEl, wkPctEl, wkBarEl);
    }

    // ==========================================================
    // ✅ Wire events
    // ==========================================================
    document.getElementById('dyManage').addEventListener('click', () => openModal('daily'));
    document.getElementById('wkManage').addEventListener('click', () => openModal('weekly'));
    document.getElementById('dyUncheck').addEventListener('click', () => uncheckAllThisPeriod('daily'));
    document.getElementById('wkUncheck').addEventListener('click', () => uncheckAllThisPeriod('weekly'));

    document.getElementById('dyClose').addEventListener('click', () => closeModal('daily'));
    document.getElementById('wkClose').addEventListener('click', () => closeModal('weekly'));

    document.getElementById('dyEnableAll').addEventListener('click', () => enableAll('daily'));
    document.getElementById('dyDisableAll').addEventListener('click', () => disableAll('daily'));
    document.getElementById('wkEnableAll').addEventListener('click', () => enableAll('weekly'));
    document.getElementById('wkDisableAll').addEventListener('click', () => disableAll('weekly'));
    document.getElementById('dyAddTask').addEventListener('click', () => addCustomTask('daily', dyCustomNameEl));
    document.getElementById('wkAddTask').addEventListener('click', () => addCustomTask('weekly', wkCustomNameEl));
    dyCustomNameEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') addCustomTask('daily', dyCustomNameEl); });
    wkCustomNameEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') addCustomTask('weekly', wkCustomNameEl); });

    dyModal.addEventListener('click', (e) => { if (e.target === dyModal) closeModal('daily'); });
    wkModal.addEventListener('click', (e) => { if (e.target === wkModal) closeModal('weekly'); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModal('daily'); closeModal('weekly'); } });

    btnLogin.addEventListener('click', loginGoogle);
    btnLogout.addEventListener('click', logout);

    // ==========================================================
    // ✅ Init + tick
    // ==========================================================
    renderAll();
    setAuthUI();
    setSyncState('未啟用');

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      setAuthUI();

      if (currentUser) {
        await cloudLoadThenResolve();
      } else {
        setSyncState('未啟用');
      }
    });

    setInterval(() => {
      const now = nowUtcMs();

      dyCountdownEl.textContent = formatCountdown(nextResetDailyUtcMs(now) - now);
      wkCountdownEl.textContent = formatCountdown(nextResetWeeklyUtcMs(now) - now);

      const newDyPk = periodKey('daily', now);
      const newWkPk = periodKey('weekly', now);

      if (dyPeriodKeyEl.textContent !== newDyPk || wkPeriodKeyEl.textContent !== newWkPk) {
        renderAll();
        cloudSaveDebounced();
      }
    }, 1000);

    // 關頁/切背景時補最後一次同步
    window.addEventListener('pagehide', () => { flushCloudSave(); });
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') { flushCloudSave(); }
    });
  </script>
</body>

</html>
